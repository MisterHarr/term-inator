<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Term-inator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    <style>
        /* Base Reset */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: #333;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 1s ease, filter 0.6s ease;
        }

        /* Animated Gradients */
        .bg-school {
            background: linear-gradient(-45deg, #4facfe, #00f2fe, #43e97b, #38f9d7);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        .bg-holiday {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: box-shadow 0.4s ease, background 0.4s ease;
        }

        .timer-card {
            background: white;
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition:
                transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                box-shadow 0.3s ease,
                background 0.3s ease;
        }

        .timer-card:hover {
            transform: scale(1.05) rotate(1deg);
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
        }

        .status-school {
            background-color: #fef08a; /* yellow-200 */
            color: #854d0e;            /* yellow-800 */
        }

        .status-holiday {
            background-color: #bbf7d0; /* green-200 */
            color: #14532d;            /* green-900 */
        }

        .floating-item {
            position: absolute;
            opacity: 0.4;
            animation: float 8s ease-in-out infinite;
            user-select: none;
            z-index: -1;
            transition: opacity 0.4s ease;
        }

        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(10deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }

        .number-change {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .btn-hover:hover {
            transform: scale(1.1);
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Theme presets */
        /* Calm: softer, slower gradient, minimal icons, gentle surfaces */
        .theme-calm.bg-school,
        .theme-calm.bg-holiday {
            animation-duration: 40s;
            filter: saturate(0.65) brightness(0.98) contrast(0.95);
        }

        .theme-calm .glass-panel {
            background: rgba(255, 255, 255, 0.16);
            border: 1px solid rgba(255, 255, 255, 0.22);
            box-shadow:
                0 10px 40px rgba(2, 6, 23, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.18);
        }

        .theme-calm .timer-card {
            background: rgba(255, 255, 255, 0.92);
            box-shadow:
                0 8px 22px rgba(2, 6, 23, 0.18),
                inset 0 1px 0 rgba(255, 255, 255, 0.55);
            transform: none !important;
        }

        .theme-calm .floating-item {
            opacity: 0.10;
            filter: blur(0.3px);
            animation-duration: 22s;
        }

        .theme-calm .status-badge {
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.12);
        }

        /* Dark & moody: deeper gradients, slower drift, shadowy glass, subdued icons */
        .theme-hyped.bg-school,
        .theme-hyped.bg-holiday {
            animation-duration: 18s;
            filter: saturate(0.95) brightness(0.62) contrast(1.15);
        }

        .theme-hyped .glass-panel {
            background: rgba(2, 6, 23, 0.55);
            border: 1px solid rgba(255, 255, 255, 0.10);
            box-shadow:
                0 24px 70px rgba(0, 0, 0, 0.65),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);
        }

        .theme-hyped .timer-card {
            background: rgba(15, 23, 42, 0.88);
            box-shadow:
                0 18px 45px rgba(0, 0, 0, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);
            animation: none;
        }

        .theme-hyped .floating-item {
            opacity: 0.06;
            filter: grayscale(1) blur(0.8px);
            animation-duration: 28s;
        }

        .theme-hyped .status-badge {
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
        }

    </style>
</head>
<body id="body-bg" class="flex flex-col items-center justify-center text-white relative w-full min-h-screen">

    <!-- Background Elements Container -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div id="bg-icons" class="w-full h-full relative">
            <!-- Icons injected by JS -->
        </div>
    </div>

    <!-- Fullscreen Toggle Button -->
    <button onclick="toggleFullScreen()" class="absolute top-4 right-4 z-50 p-3 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 text-white transition-all btn-hover" title="Toggle Fullscreen">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
        </svg>
    </button>

    <main class="glass-panel p-4 sm:p-6 md:p-12 lg:p-16 xl:p-20 rounded-3xl text-center w-full max-w-5xl mx-auto z-10 flex flex-col items-center justify-center min-h-[50vh] transition-all duration-500">

        <!-- Status + day type row -->
        <div class="flex flex-col items-center gap-1 mb-3">
            <div id="status-badge" class="status-badge status-school text-xs sm:text-sm md:text-base lg:text-xl">
                Checking Schedule...
            </div>

            <!-- Day type pill -->
            <div id="day-type" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/15 text-white/90 text-xs sm:text-sm font-semibold">
                <span id="day-type-dot" class="w-2 h-2 rounded-full bg-emerald-300"></span>
                <span id="day-type-text">Day type...</span>
            </div>
        </div>

        <h2 class="text-sm sm:text-lg md:text-2xl lg:text-3xl font-bold uppercase tracking-widest text-white/80 mb-2">
            Counting down to
        </h2>

        <h1 id="event-name" class="text-3xl md:text-5xl lg:text-7xl xl:text-8xl font-bold mb-4 drop-shadow-md text-white min-h-[1.2em] leading-tight">
            ...
        </h1>

        <p id="event-date-display" class="text-base sm:text-lg md:text-xl lg:text-3xl opacity-90 mb-4 md:mb-6 font-semibold text-white/90">
            ...
        </p>

        <!-- Progress bar for current period -->
        <div class="w-full max-w-3xl mx-auto mb-6">
            <div class="flex justify-between text-[0.6rem] sm:text-xs text-white/80 mb-1">
                <span id="period-start-label">Period start</span>
                <span id="period-end-label">Period end</span>
            </div>
            <div class="w-full h-3 bg-white/20 rounded-full overflow-hidden">
                <div id="progress-bar-fill" class="h-full bg-gradient-to-r from-emerald-300 to-cyan-400 transition-all duration-700" style="width: 0%;"></div>
            </div>
            <p id="progress-percentage" class="mt-1 text-[0.65rem] sm:text-xs md:text-sm text-white/80 text-right">
                ...
            </p>
        </div>

        <div id="timer-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 lg:gap-10 w-full">
            <!-- Days -->
            <div class="timer-card rounded-2xl p-3 sm:p-4 lg:p-8 flex flex-col items-center justify-center text-gray-800 aspect-auto md:aspect-square">
                <span id="days" class="text-3xl sm:text-4xl md:text-6xl lg:text-8xl xl:text-9xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-purple-500 to-indigo-600">00</span>
                <span class="text-[0.6rem] sm:text-xs md:text-sm lg:text-xl font-bold text-gray-400 uppercase tracking-widest mt-2 lg:mt-4">Days</span>
            </div>
            <!-- Hours -->
            <div class="timer-card rounded-2xl p-3 sm:p-4 lg:p-8 flex flex-col items-center justify-center text-gray-800 aspect-auto md:aspect-square">
                <span id="hours" class="text-3xl sm:text-4xl md:text-6xl lg:text-8xl xl:text-9xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-pink-500 to-rose-600">00</span>
                <span class="text-[0.6rem] sm:text-xs md:text-sm lg:text-xl font-bold text-gray-400 uppercase tracking-widest mt-2 lg:mt-4">Hours</span>
            </div>
            <!-- Minutes -->
            <div class="timer-card rounded-2xl p-3 sm:p-4 lg:p-8 flex flex-col items-center justify-center text-gray-800 aspect-auto md:aspect-square">
                <span id="minutes" class="text-3xl sm:text-4xl md:text-6xl lg:text-8xl xl:text-9xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-orange-400 to-red-500">00</span>
                <span class="text-[0.6rem] sm:text-xs md:text-sm lg:text-xl font-bold text-gray-400 uppercase tracking-widest mt-2 lg:mt-4">Minutes</span>
            </div>
            <!-- Seconds -->
            <div class="timer-card rounded-2xl p-3 sm:p-4 lg:p-8 flex flex-col items-center justify-center text-gray-800 aspect-auto md:aspect-square">
                <span id="seconds" class="text-3xl sm:text-4xl md:text-6xl lg:text-8xl xl:text-9xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-green-400 to-emerald-600">00</span>
                <span class="text-[0.6rem] sm:text-xs md:text-sm lg:text-xl font-bold text-gray-400 uppercase tracking-widest mt-2 lg:mt-4">Seconds</span>
            </div>
        </div>

        <div id="message" class="hidden flex-col items-center justify-center mt-8 space-y-4">
            <h2 class="text-4xl md:text-6xl lg:text-8xl font-bold text-yellow-300 drop-shadow-lg animate-bounce">It's Time! ðŸŽ‰</h2>
        </div>

        <!-- Next events list -->
        <div class="mt-6 w-full max-w-3xl mx-auto text-left text-xs sm:text-sm text-white/90">
            <h3 class="font-semibold mb-1">Next 3 events</h3>
            <ul id="next-events-list" class="space-y-1">
                <!-- Filled by JS -->
            </ul>
        </div>

        <!-- Teacher mode panel -->
        <div class="mt-6 w-full max-w-3xl text-left text-xs sm:text-sm text-white/85">
            <button id="teacher-toggle" class="flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 transition-all">
                <span>ðŸŽ“ Teacher mode</span>
                <span id="teacher-toggle-icon" class="text-[0.7rem]">â–¼</span>
            </button>
            <div id="teacher-panel" class="mt-3 hidden rounded-2xl bg-white/10 border border-white/20 p-4">
                <div class="flex flex-col gap-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="skip-weekends-checkbox" type="checkbox" class="accent-emerald-400">
                        <span>Skip weekends in countdown (Days show Monâ€“Fri only)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="show-icons-checkbox" type="checkbox" class="accent-emerald-400" checked>
                        <span>Show floating background icons</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="confetti-checkbox" type="checkbox" class="accent-emerald-400" checked>
                        <span>Confetti when countdown hits zero</span>
                    </label>
                </div>

                <!-- Theme control only -->
                <div class="mt-3 border-t border-white/10 pt-3">
                    <div class="font-semibold mb-1 text-[0.7rem] sm:text-xs uppercase tracking-wide text-white/70">
                        Theme preset
                    </div>
                    <select id="theme-preset-select" class="w-full bg-white/10 border border-white/30 rounded-md px-2 py-1 text-xs sm:text-sm text-white">
                        <option value="default">Default</option>
                        <option value="calm">Calm classroom</option>
                        <option value="hyped">Hyped Friday</option>
                    </select>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-4 mb-4 text-white/70 text-xs md:text-sm font-semibold z-10">
        Timezone: Asia/Kuala_Lumpur (GMT+8)
    </footer>

    <script>
        // ==========================================
        //  USER CONFIGURATION: GIS SCHEDULE 2025/2026
        // ==========================================
        const schedule = [
            { date: "2025-12-12T11:30:00", name: "Term 1 Holiday Start", type: 'start' },
            { date: "2026-01-05T07:00:00", name: "Term 2 Begins", type: 'end' },
            { date: "2026-01-30T15:00:00", name: "FT Day/Thaipusam Break", type: 'start' },
            { date: "2026-02-04T07:00:00", name: "Back to School", type: 'end' },
            { date: "2026-02-13T15:00:00", name: "Mid-Term Break (CNY)", type: 'start' },
            { date: "2026-02-23T07:00:00", name: "Back to School", type: 'end' },
            { date: "2026-03-20T15:00:00", name: "Hari Raya Break", type: 'start' },
            { date: "2026-03-24T07:00:00", name: "Back to School", type: 'end' },
            { date: "2026-04-03T11:30:00", name: "Term 2 Holidays", type: 'start' },
            { date: "2026-04-20T07:00:00", name: "Term 3 Begins", type: 'end' },
            { date: "2026-04-30T15:00:00", name: "Labour Day Break", type: 'start' },
            { date: "2026-05-05T07:00:00", name: "Back to School", type: 'end' },
            { date: "2026-05-29T15:00:00", name: "Agong's Birthday Break", type: 'start' },
            { date: "2026-06-03T07:00:00", name: "Back to School", type: 'end' },
            { date: "2026-06-16T15:00:00", name: "Awal Muharram Break", type: 'start' },
            { date: "2026-06-18T07:00:00", name: "Back to School", type: 'end' },
            { date: "2026-06-26T11:30:00", name: "Summer Holidays", type: 'start' },
            { date: "2026-08-13T07:00:00", name: "New Academic Year", type: 'end' }
        ];

        // ==========================================
        //  ARRAYS FOR DIFFERENT MODES
        // ==========================================
        const schoolIcons = ['ðŸ“š', 'âœï¸', 'ðŸ«', 'ðŸŽ’', 'ðŸšŒ', 'ðŸ“', 'ðŸ§ ', 'ðŸ“', 'ðŸ’»'];
        const holidayIcons = ['ðŸŽ‰', 'ðŸ–ï¸', 'ðŸŽ®', 'ðŸ›Œ', 'ðŸ•', 'ðŸŒž', 'âœˆï¸', 'ðŸ¦', 'ðŸš²'];

        // ==========================================
        //  SETTINGS (LOCAL-ONLY)
        // ==========================================
        const SETTINGS_KEY = 'terminatorSettings';
        const defaultSettings = {
            skipWeekends: false,
            showIcons: true,
            confetti: true,
            themePreset: 'default'
        };
        let settings = { ...defaultSettings };

        function loadSettings() {
            try {
                const stored = localStorage.getItem(SETTINGS_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    settings = { ...defaultSettings, ...parsed };
                }
            } catch (e) {
                console.warn('Failed to load settings', e);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            } catch (e) {
                console.warn('Failed to save settings', e);
            }
        }

        // ==========================================
        //  LOGIC START
        // ==========================================
        const els = {
            body: document.getElementById('body-bg'),
            eventName: document.getElementById('event-name'),
            eventDateDisplay: document.getElementById('event-date-display'),
            statusBadge: document.getElementById('status-badge'),
            bgIcons: document.getElementById('bg-icons'),
            days: document.getElementById('days'),
            hours: document.getElementById('hours'),
            minutes: document.getElementById('minutes'),
            seconds: document.getElementById('seconds'),
            timerContainer: document.getElementById('timer-container'),
            message: document.getElementById('message'),
            dayTypeText: document.getElementById('day-type-text'),
            dayTypeDot: document.getElementById('day-type-dot'),
            progressBarFill: document.getElementById('progress-bar-fill'),
            progressPercentage: document.getElementById('progress-percentage'),
            periodStartLabel: document.getElementById('period-start-label'),
            periodEndLabel: document.getElementById('period-end-label'),
            teacherToggle: document.getElementById('teacher-toggle'),
            teacherToggleIcon: document.getElementById('teacher-toggle-icon'),
            teacherPanel: document.getElementById('teacher-panel'),
            skipWeekendsCheckbox: document.getElementById('skip-weekends-checkbox'),
            showIconsCheckbox: document.getElementById('show-icons-checkbox'),
            confettiCheckbox: document.getElementById('confetti-checkbox'),
            themePresetSelect: document.getElementById('theme-preset-select'),
            nextEventsList: document.getElementById('next-events-list')
        };

        let currentMode = null;
        let currentTarget = null;
        let confettiLaunched = false;

        // Load settings before first render
        loadSettings();

        // Sync controls with settings
        els.skipWeekendsCheckbox.checked = settings.skipWeekends;
        els.showIconsCheckbox.checked = settings.showIcons;
        els.confettiCheckbox.checked = settings.confetti;
        els.themePresetSelect.value = settings.themePreset || 'default';

        // Teacher mode events
        els.teacherToggle.addEventListener('click', () => {
            const isHidden = els.teacherPanel.classList.contains('hidden');
            if (isHidden) {
                els.teacherPanel.classList.remove('hidden');
                els.teacherToggleIcon.textContent = 'â–²';
            } else {
                els.teacherPanel.classList.add('hidden');
                els.teacherToggleIcon.textContent = 'â–¼';
            }
        });

        els.skipWeekendsCheckbox.addEventListener('change', () => {
            settings.skipWeekends = els.skipWeekendsCheckbox.checked;
            saveSettings();
        });

        els.showIconsCheckbox.addEventListener('change', () => {
            settings.showIcons = els.showIconsCheckbox.checked;
            saveSettings();
            if (currentMode) {
                updateTheme(currentMode);
            }
        });

        els.confettiCheckbox.addEventListener('change', () => {
            settings.confetti = els.confettiCheckbox.checked;
            saveSettings();
        });

        els.themePresetSelect.addEventListener('change', () => {
            settings.themePreset = els.themePresetSelect.value;
            saveSettings();
            if (currentMode) {
                updateTheme(currentMode);
            }
        });

        function parseScheduleDate(dateStr) {
            const parts = dateStr.split(/[-T:]/);
            return new Date(
                parseInt(parts[0], 10),
                parseInt(parts[1], 10) - 1,
                parseInt(parts[2], 10),
                parseInt(parts[3], 10),
                parseInt(parts[4], 10),
                parseInt(parts[5], 10)
            );
        }

        function updateTheme(mode) {
            currentMode = mode;

            // Determine theme class
            let themeClass = '';
            if (settings.themePreset === 'calm') {
                themeClass = 'theme-calm';
            } else if (settings.themePreset === 'hyped') {
                themeClass = 'theme-hyped';
            }

            if (mode === 'school') {
                els.body.className =
                    "flex flex-col items-center justify-center text-white relative w-full min-h-screen bg-school " +
                    themeClass;
                els.statusBadge.className =
                    'status-badge status-school text-xs sm:text-sm md:text-base lg:text-xl';
                els.statusBadge.textContent = 'Time Until Sleep ðŸ˜´';
                els.eventName.className =
                    "text-3xl md:text-5xl lg:text-7xl xl:text-8xl font-bold mb-4 drop-shadow-md text-white min-h-[1.2em] leading-tight";
            } else {
                els.body.className =
                    "flex flex-col items-center justify-center text-white relative w-full min-h-screen bg-holiday " +
                    themeClass;
                els.statusBadge.className =
                    'status-badge status-holiday text-xs sm:text-sm md:text-base lg:text-xl';
                els.statusBadge.textContent = 'T-Minus to Term Launch ðŸš€';
                els.eventName.className =
                    "text-3xl md:text-5xl lg:text-7xl xl:text-8xl font-bold mb-4 drop-shadow-md text-yellow-200 min-h-[1.2em] leading-tight";
            }

            // Floating icons
            els.bgIcons.innerHTML = '';
            if (!settings.showIcons) return;

            const icons = mode === 'school' ? schoolIcons : holidayIcons;

            // Icon count depends on theme (more for hyped, fewer for calm)
            let iconCount = 12;
            if (settings.themePreset === 'calm') iconCount = 8;
            if (settings.themePreset === 'hyped') iconCount = 18;

            for (let i = 0; i < iconCount; i++) {
                const div = document.createElement('div');
                div.className = 'floating-item';
                div.textContent = icons[Math.floor(Math.random() * icons.length)];
                div.style.left = Math.random() * 95 + '%';
                div.style.top = Math.random() * 95 + '%';
                div.style.animationDelay = (Math.random() * 5) + 's';
                const size = Math.random() * 3 + 2;
                div.style.fontSize = size + 'rem';
                els.bgIcons.appendChild(div);
            }
        }

        function determineTarget(nowMYT) {
            const nowTime = nowMYT.getTime();

            for (let i = 0; i < schedule.length; i++) {
                const event = schedule[i];
                const targetAsLocal = parseScheduleDate(event.date);

                if (nowTime < targetAsLocal.getTime()) {
                    const mode = event.type === 'start' ? 'school' : 'holiday';

                    // Determine the start of the current period (previous event if exists)
                    let periodStartDate;
                    let periodStartLabel;
                    if (i > 0) {
                        const prevEvent = schedule[i - 1];
                        periodStartDate = parseScheduleDate(prevEvent.date);
                        periodStartLabel = prevEvent.name;
                    } else {
                        // Fallback: 30 days before if no previous event
                        periodStartDate = new Date(targetAsLocal.getTime() - 30 * 24 * 60 * 60 * 1000);
                        periodStartLabel = mode === 'school' ? 'Term Block Start' : 'Holiday Block Start';
                    }

                    return {
                        mode: mode,
                        targetDate: targetAsLocal,
                        periodStartDate: periodStartDate,
                        title: event.name,
                        displayDate: targetAsLocal.toLocaleDateString('en-GB', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }),
                        periodStartLabel: periodStartLabel,
                        periodEndLabel: event.name
                    };
                }
            }

            // If all events in the past: generic fallback
            const fallbackTarget = new Date(nowTime + 86400000 * 30);
            const fallbackStart = new Date(nowTime);
            return {
                mode: 'holiday',
                targetDate: fallbackTarget,
                periodStartDate: fallbackStart,
                title: "Academic Year Complete!",
                displayDate: "See you next year",
                periodStartLabel: 'End of Year',
                periodEndLabel: 'Next Academic Year'
            };
        }

        function updateDayType(nowMYT) {
            // Determine if we are in a holiday period based on schedule
            let inHoliday = false;
            for (let i = 0; i < schedule.length; i++) {
                const event = schedule[i];
                const eventDate = parseScheduleDate(event.date);

                if (event.type === 'start' && eventDate <= nowMYT) {
                    // Look for the next 'end' after this start
                    let endDate = null;
                    for (let j = i + 1; j < schedule.length; j++) {
                        if (schedule[j].type === 'end') {
                            endDate = parseScheduleDate(schedule[j].date);
                            break;
                        }
                    }
                    if (!endDate || nowMYT < endDate) {
                        inHoliday = true;
                        break;
                    }
                }
            }

            let label = '';
            let dotColor = '';

            if (inHoliday) {
                label = 'Holiday';
                dotColor = '#facc15'; // yellow-400
            } else {
                const day = nowMYT.getDay();
                if (day === 0 || day === 6) {
                    label = 'Weekend';
                    dotColor = '#60a5fa'; // blue-400
                } else {
                    label = 'School Day';
                    dotColor = '#4ade80'; // green-400
                }
            }

            els.dayTypeText.textContent = label;
            els.dayTypeDot.style.backgroundColor = dotColor;
        }

        function updateProgress(nowMYT) {
            if (!currentTarget || !currentTarget.periodStartDate) return;

            const start = currentTarget.periodStartDate;
            const end = currentTarget.targetDate;

            if (end <= start) {
                els.progressBarFill.style.width = '100%';
                els.progressPercentage.textContent = 'Current block complete';
                return;
            }

            const total = end - start;
            const elapsed = Math.min(Math.max(nowMYT - start, 0), total);
            const percent = (elapsed / total) * 100;

            els.progressBarFill.style.width = `${percent.toFixed(1)}%`;
            els.progressPercentage.textContent =
                `${percent.toFixed(1)}% of this ${currentTarget.mode === 'school' ? 'school block' : 'holiday block'} done`;

            els.periodStartLabel.textContent = currentTarget.periodStartLabel || 'Start';
            els.periodEndLabel.textContent = currentTarget.periodEndLabel || 'End';
        }

        function countWeekdays(start, end) {
            // Count Monâ€“Fri full days between start and end (ignoring the exact time of day)
            if (end <= start) return 0;

            const startDate = new Date(start.getFullYear(), start.getMonth(), start.getDate());
            const endDate = new Date(end.getFullYear(), end.getMonth(), end.getDate());

            let count = 0;
            const current = new Date(startDate);

            while (current < endDate) {
                const day = current.getDay();
                if (day !== 0 && day !== 6) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }

            return count;
        }

        function updateNextEvents(nowMYT) {
            els.nextEventsList.innerHTML = '';

            const upcoming = schedule
                .map(ev => ({
                    ...ev,
                    dateObj: parseScheduleDate(ev.date)
                }))
                .filter(ev => ev.dateObj > nowMYT)
                .slice(0, 3);

            if (upcoming.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No more scheduled events.';
                els.nextEventsList.appendChild(li);
                return;
            }

            upcoming.forEach(ev => {
                const li = document.createElement('li');
                const labelSpan = document.createElement('span');
                const dateSpan = document.createElement('span');

                labelSpan.textContent = ev.name;
                labelSpan.className = 'font-semibold';

                dateSpan.textContent = ' â€“ ' + ev.dateObj.toLocaleDateString('en-GB', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                li.appendChild(labelSpan);
                li.appendChild(dateSpan);
                els.nextEventsList.appendChild(li);
            });
        }

        function updateTimer() {
            const nowUTC = new Date();
            const mytString = nowUTC.toLocaleString('en-US', {
                timeZone: 'Asia/Kuala_Lumpur',
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: false
            });
            const nowMYT = new Date(mytString);

            if (!currentTarget || currentTarget.targetDate < nowMYT) {
                const data = determineTarget(nowMYT);
                currentTarget = data;

                els.eventName.textContent = data.title;
                els.eventDateDisplay.textContent = data.displayDate;

                updateTheme(data.mode);

                confettiLaunched = false;
                els.message.classList.add('hidden');
                els.timerContainer.classList.remove('hidden');

                // Update next events when target changes
                updateNextEvents(nowMYT);
            }

            // Real diff for timing & confetti
            let realDiff = currentTarget.targetDate - nowMYT;
            if (realDiff <= 0) {
                realDiff = 0;
                if (!confettiLaunched) {
                    launchConfetti();
                    confettiLaunched = true;
                    setTimeout(() => { currentTarget = null; }, 5000);
                }
            }

            const dayMs = 1000 * 60 * 60 * 24;
            const hourMs = 1000 * 60 * 60;
            const minuteMs = 1000 * 60;

            const daysReal = Math.floor(realDiff / dayMs);
            const hours = Math.floor((realDiff % dayMs) / hourMs);
            const minutes = Math.floor((realDiff % hourMs) / minuteMs);
            const seconds = Math.floor((realDiff % minuteMs) / 1000);

            // Apply weekend-skipping logic to Days only
            let daysDisplay = daysReal;
            if (settings.skipWeekends) {
                daysDisplay = countWeekdays(nowMYT, currentTarget.targetDate);
            }

            updateDisplay(els.days, daysDisplay);
            updateDisplay(els.hours, hours);
            updateDisplay(els.minutes, minutes);
            updateDisplay(els.seconds, seconds);

            // Update day type & progress bar
            updateDayType(nowMYT);
            updateProgress(nowMYT);
        }

        function updateDisplay(el, value) {
            const strVal = value < 10 ? '0' + value : value.toString();
            if (el.innerText !== strVal) {
                el.innerText = strVal;
                el.classList.remove('number-change');
                void el.offsetWidth;
                el.classList.add('number-change');
            }
        }

        function launchConfetti() {
            if (!settings.confetti) return;

            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            const interval = setInterval(function () {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    return;
                }
                const particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, {
                    particleCount,
                    origin: { x: Math.random(), y: Math.random() - 0.2 }
                }));
            }, 250);
        }

        // Fullscreen Toggle
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch((e) => {
                    console.log("Fullscreen not allowed", e);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Start timer loop
        updateTimer();
        setInterval(updateTimer, 1000);
    </script>
</body>
</html>
